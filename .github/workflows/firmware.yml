name: firmware

# For now, this workflow is used for checks, not for releases.
# So all release stuff is commented out.

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  pull_request: {}

permissions:
  contents: write

jobs:
  keira:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0

      - uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.platformio/.cache
            ./.pio
          key: ${{ runner.os }}-keira

      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install PlatformIO Core
        run: pip install --upgrade platformio

      - name: Extract version and generate Keira header
        id: version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
            VERSION="${TAG#v}"
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

            # Use prerelease info from event payload if available
            if [[ "${GITHUB_EVENT_NAME}" == "release" && "${GITHUB_EVENT_RELEASE_PRERELEASE}" == "true" ]]; then
              VERSION_TYPE="KEIRA_VERSION_TYPE_PRE_RELEASE"
            else
              VERSION_TYPE="KEIRA_VERSION_TYPE_RELEASE"
            fi
          else
            MAJOR=0
            MINOR=0
            PATCH=0
            VERSION="0.0.0"
            VERSION_TYPE="KEIRA_VERSION_TYPE_DEV"
          fi

          mkdir -p lib/keira/include
          cat > lib/keira/include/keira_version_auto_gen.h <<EOF
          #pragma once
          #ifndef KEIRA_VERSION_AUTO_GEN_H
          #define KEIRA_VERSION_AUTO_GEN_H

          #define KEIRA_VERSION_MAJOR $MAJOR
          #define KEIRA_VERSION_MINOR $MINOR
          #define KEIRA_VERSION_PATCH $PATCH
          #define KEIRA_VERSION_TYPE $VERSION_TYPE

          #endif // KEIRA_VERSION_AUTO_GEN_H
          EOF

          echo "Generated version:"
          cat lib/keira/include/keira_version_auto_gen.h

          # Export outputs for later steps
          echo "MAJOR=$MAJOR" >> $GITHUB_OUTPUT
          echo "MINOR=$MINOR" >> $GITHUB_OUTPUT
          echo "PATCH=$PATCH" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TYPE=$VERSION_TYPE" >> $GITHUB_OUTPUT

      - name: Build and package firmware
        run: |
          mkdir -p out
          if [[ "${{ steps.version.outputs.VERSION_TYPE }}" != "KEIRA_VERSION_TYPE_DEV" ]]; then
            echo "Tag detected - building for all languages"
            for lang in $(cat languages.txt); do
              echo "Building for $lang"
              PLATFORMIO_BUILD_FLAGS=-D$lang pio run -e v2
              cp .pio/build/v2/firmware.bin out/keira_${lang}.bin
              cp .pio/build/v2/partitions.bin out/partitions.bin
              cp .pio/build/v2/bootloader.bin out/bootloader.bin
              pip install esptool
              esptool.py --chip esp32s3 merge_bin \
                -o out/KeiraOS_merged_${lang}.bin \
                0x0 out/bootloader.bin \
                0x8000 out/partitions.bin \
                0x10000 out/keira_${lang}.bin
            done
          else
            echo "Main branch or PR - building for default language only"
            pio run -e v2
            cp .pio/build/v2/firmware.bin out/keira.bin
            cp .pio/build/v2/partitions.bin out/partitions.bin
            cp .pio/build/v2/bootloader.bin out/bootloader.bin
            pip install esptool
            esptool.py --chip esp32s3 merge_bin \
              -o out/KeiraOS_merged.bin \
              0x0 out/bootloader.bin \
              0x8000 out/partitions.bin \
              0x10000 out/keira.bin
          fi

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: KeiraOS-firmware
          path: out/*.bin

      - name: Upload KeiraOS bins to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: out/*.bin